name: Kindling CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  PYTHON_VERSION: "3.11"

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          pytest tests/unit/ \
            --cov=kindling \
            --cov-report=xml \
            --cov-report=html:output/htmlcov \
            --junit-xml=output/unit-test-results.xml \
            -v

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: unit-test-results
          path: |
            output/unit-test-results.xml
            output/htmlcov/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  lint-and-format:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Black formatter check
        run: |
          black --check --diff src/ tests/

      - name: Run pylint
        run: |
          pylint src/kindling/ --output-format=parseable --exit-zero > output/pylint-report.txt

      - name: Run mypy type checking
        run: |
          mypy src/kindling/ --html-report output/mypy-report || true

      - name: Upload code quality reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: code-quality-reports
          path: output/

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, lint-and-format]
    environment: testing
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_TEST }}

      - name: Run integration tests
        env:
          AZURE_STORAGE_ACCOUNT: ${{ vars.TEST_STORAGE_ACCOUNT }}
          AZURE_CONTAINER: ${{ vars.TEST_CONTAINER }}
          AZURE_BASE_PATH: ci-tests/${{ github.run_id }}
        run: |
          pytest tests/integration/ \
            --junit-xml=output/integration-test-results.xml \
            -v

      - name: Upload integration test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-results
          path: output/integration-test-results.xml

  kda-packaging-tests:
    name: KDA Packaging Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run KDA packaging tests
        run: |
          pytest tests/system/test_kda_packaging.py \
            --junit-xml=output/kda-test-results.xml \
            -v

      - name: Run simple KDA workflow test
        run: |
          python tests/system/test_simple_kda_synapse.py

      - name: Upload KDA test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: kda-test-results
          path: output/

  system-tests:
    name: System Tests (${{ matrix.platform }})
    runs-on: ubuntu-latest
    needs: [integration-tests, kda-packaging-tests]
    environment: staging
    if: github.ref == 'refs/heads/main' || github.event_name == 'release'

    strategy:
      matrix:
        platform: [synapse, databricks, fabric, local]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}

      - name: Run system tests
        env:
          TARGET_PLATFORM: ${{ matrix.platform }}
          AZURE_STORAGE_ACCOUNT: ${{ vars.STAGING_STORAGE_ACCOUNT }}
          AZURE_CONTAINER: ${{ vars.STAGING_CONTAINER }}
          AZURE_BASE_PATH: system-tests/${{ github.run_id }}/${{ matrix.platform }}
        run: |
          pytest tests/system/ \
            --platform=${{ matrix.platform }} \
            --junit-xml=output/system-test-results-${{ matrix.platform }}.xml \
            -v

      - name: Upload system test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: system-test-results-${{ matrix.platform }}
          path: output/

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install safety bandit

      - name: Run safety check for known vulnerabilities
        run: |
          safety check --json --output output/safety-report.json || true

      - name: Run bandit security analysis
        run: |
          bandit -r src/ -f json -o output/bandit-report.json || true

      - name: Upload security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: output/

  build-package:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [unit-tests, lint-and-format]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: |
          python -m build

      - name: Check package
        run: |
          twine check dist/*

      - name: Upload package artifacts
        uses: actions/upload-artifact@v3
        with:
          name: python-package
          path: dist/

  publish-to-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-package, system-tests, security-scan]
    environment: production
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
      - name: Download package artifacts
        uses: actions/download-artifact@v3
        with:
          name: python-package
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

      - name: Create deployment record
        run: |
          echo "Package published to PyPI at $(date)" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      [
        unit-tests,
        integration-tests,
        kda-packaging-tests,
        system-tests,
        security-scan,
      ]
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v3

      - name: Generate test summary
        run: |
          echo "# ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY

          # Check unit tests
          if [ "${{ needs.unit-tests.result }}" == "success" ]; then
            echo "| Unit Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Unit Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check integration tests
          if [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "| Integration Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.integration-tests.result }}" == "skipped" ]; then
            echo "| Integration Tests | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Integration Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check KDA tests
          if [ "${{ needs.kda-packaging-tests.result }}" == "success" ]; then
            echo "| KDA Packaging Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| KDA Packaging Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check system tests
          if [ "${{ needs.system-tests.result }}" == "success" ]; then
            echo "| System Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.system-tests.result }}" == "skipped" ]; then
            echo "| System Tests | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| System Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check security scan
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "| Security Scan | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Security Scan | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
