name: Kindling CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  PYTHON_VERSION: "3.11"

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: |
          poetry install --with dev

      - name: Run unit tests
        run: |
          poetry run pytest tests/unit/ \
            --cov=packages/kindling \
            --cov-report=xml \
            --cov-report=html:htmlcov \
            --junit-xml=test-results/unit-test-results.xml \
            -v

      - name: Create output directory for backwards compatibility
        run: mkdir -p output && cp -r htmlcov test-results/unit-test-results.xml output/ 2>/dev/null || true

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: unit-test-results
          path: |
            test-results/unit-test-results.xml
            htmlcov/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  lint-and-format:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: |
          poetry install --with dev

      - name: Run Black formatter check
        run: |
          poetry run black --check --diff packages/ tests/

      - name: Run pylint
        run: |
          mkdir -p output
          poetry run pylint packages/kindling/ --output-format=parseable --exit-zero > output/pylint-report.txt

      - name: Run mypy type checking
        run: |
          poetry run mypy packages/kindling/ --html-report output/mypy-report || true

      - name: Upload code quality reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: code-quality-reports
          path: output/

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, lint-and-format]
    environment: testing
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: |
          poetry install --with dev

      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_TEST }}

      - name: Run integration tests
        env:
          AZURE_STORAGE_ACCOUNT: ${{ vars.TEST_STORAGE_ACCOUNT }}
          AZURE_CONTAINER: ${{ vars.TEST_CONTAINER }}
          AZURE_BASE_PATH: ci-tests/${{ github.run_id }}
        run: |
          poetry run pytest tests/integration/ \
            --junit-xml=test-results/integration-test-results.xml \
            -v

      - name: Upload integration test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-results
          path: test-results/integration-test-results.xml

  kda-packaging-tests:
    name: KDA Packaging Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: |
          poetry install --with dev

      - name: Run KDA packaging tests
        run: |
          mkdir -p test-results
          poetry run python tests/test_kda_packaging.py

      - name: Run simple KDA workflow test
        run: |
          poetry run python tests/system/test_simple_kda_synapse.py

      - name: Upload KDA test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: kda-test-results
          path: test-results/

  system-tests:
    name: System Tests (${{ matrix.platform }})
    runs-on: ubuntu-latest
    needs: [integration-tests, kda-packaging-tests]
    environment: staging
    if: github.ref == 'refs/heads/main' || github.event_name == 'release'

    strategy:
      matrix:
        platform: [synapse, databricks, fabric, local]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: |
          poetry install --with dev

      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}

      - name: Run system tests
        env:
          TARGET_PLATFORM: ${{ matrix.platform }}
          AZURE_STORAGE_ACCOUNT: ${{ vars.STAGING_STORAGE_ACCOUNT }}
          AZURE_CONTAINER: ${{ vars.STAGING_CONTAINER }}
          AZURE_BASE_PATH: system-tests/${{ github.run_id }}/${{ matrix.platform }}
        run: |
          mkdir -p test-results
          poetry run pytest tests/system/ \
            --platform=${{ matrix.platform }} \
            --junit-xml=test-results/system-test-results-${{ matrix.platform }}.xml \
            -v || true

      - name: Upload system test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: system-test-results-${{ matrix.platform }}
          path: test-results/

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install dependencies
        run: |
          poetry install --with dev
          pip install safety bandit

      - name: Run safety check for known vulnerabilities
        run: |
          mkdir -p output
          safety check --json --output output/safety-report.json || true

      - name: Run bandit security analysis
        run: |
          bandit -r packages/ -f json -o output/bandit-report.json || true

      - name: Upload security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: output/

  build-platform-wheels:
    name: Build Platform Wheels
    runs-on: ubuntu-latest
    needs: [unit-tests, lint-and-format]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Build platform-specific wheels
        run: |
          chmod +x scripts/build_platform_wheels.sh
          bash scripts/build_platform_wheels.sh

      - name: List built wheels
        run: |
          echo "ðŸ“¦ Built wheels:"
          ls -lh dist/

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v3
        with:
          name: platform-wheels
          path: dist/*.whl

  attach-wheels-to-release:
    name: Attach Wheels to Release
    runs-on: ubuntu-latest
    needs: [build-platform-wheels]
    if: github.event_name == 'release' && github.event.action == 'published'
    permissions:
      contents: write

    steps:
      - name: Download wheel artifacts
        uses: actions/download-artifact@v3
        with:
          name: platform-wheels
          path: dist/

      - name: Attach wheels to release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release summary
        run: |
          echo "# ðŸ“¦ Release Assets Attached" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following wheels have been attached to the release:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | File |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          for wheel in dist/*.whl; do
            filename=$(basename "$wheel")
            size=$(du -h "$wheel" | cut -f1)
            echo "| ${filename%.whl} | $filename ($size) |" >> $GITHUB_STEP_SUMMARY
          done

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      [
        unit-tests,
        integration-tests,
        kda-packaging-tests,
        system-tests,
        security-scan,
      ]
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v3

      - name: Generate test summary
        run: |
          echo "# ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY

          # Check unit tests
          if [ "${{ needs.unit-tests.result }}" == "success" ]; then
            echo "| Unit Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Unit Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check integration tests
          if [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "| Integration Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.integration-tests.result }}" == "skipped" ]; then
            echo "| Integration Tests | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Integration Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check KDA tests
          if [ "${{ needs.kda-packaging-tests.result }}" == "success" ]; then
            echo "| KDA Packaging Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| KDA Packaging Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check system tests
          if [ "${{ needs.system-tests.result }}" == "success" ]; then
            echo "| System Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.system-tests.result }}" == "skipped" ]; then
            echo "| System Tests | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| System Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check security scan
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "| Security Scan | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Security Scan | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
